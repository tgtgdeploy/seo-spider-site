# ğŸ”§ æ•°æ®åº“è¿æ¥é—®é¢˜ä¿®å¤æŒ‡å—

## ğŸ”´ é—®é¢˜åˆ†æ

### å‘ç°çš„é”™è¯¯

1. **P2024 - è¿æ¥æ± è¶…æ—¶**
```
Timed out fetching a new connection from the connection pool
connection_limit: 1, timeout: 10
```
**åŸå› ï¼š** `connection_limit=1` å¤ªä½ï¼Œå¤šä¸ªAPIåŒæ—¶è¯·æ±‚æ—¶å¯¼è‡´è¿æ¥æ’é˜Ÿè¶…æ—¶

2. **P1001 - æ— æ³•è¿æ¥æ•°æ®åº“**
```
Can't reach database server at db.bsuvzqihxbgoclfvgbhx.supabase.co:5432
```
**åŸå› ï¼š** è¿æ¥æ± è€—å°½åæ–°è¯·æ±‚ç›´æ¥å¤±è´¥

### å½±å“èŒƒå›´

å—å½±å“çš„åº”ç”¨ï¼š
- âœ… seo-admin (å·²ä¿®å¤)
- âœ… seo-spider-site (å·²ä¿®å¤)
- âŒ å…¶ä»–è¿è¡Œä¸­çš„åº”ç”¨éœ€è¦é‡å¯

---

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. æ•°æ®åº“è¿æ¥é…ç½®æ›´æ–°

**Admin åå° (`seo-admin/.env.local`):**
```env
# æ—§é…ç½® (é”™è¯¯)
DATABASE_URL="...&connection_limit=1"

# æ–°é…ç½® (ä¿®å¤)
DATABASE_URL="...&connection_limit=5&pool_timeout=20"
```
- **è¿æ¥æ•°ï¼š** 1 â†’ 5 (Adminéœ€è¦å¤„ç†æ›´å¤šå¹¶å‘è¯·æ±‚)
- **è¶…æ—¶ï¼š** 10s â†’ 20s

**èœ˜è››æ± ç½‘ç«™ (æ‰€æœ‰ VPS):**
```env
# æ—§é…ç½® (é”™è¯¯)
DATABASE_URL="...&connection_limit=1"

# æ–°é…ç½® (ä¿®å¤)
DATABASE_URL="...&connection_limit=3&pool_timeout=20"
```
- **è¿æ¥æ•°ï¼š** 1 â†’ 3 (æ¯ä¸ªVPSç‹¬ç«‹è¿è¡Œï¼Œ3ä¸ªè¶³å¤Ÿ)
- **è¶…æ—¶ï¼š** 10s â†’ 20s

---

## ğŸš€ ç«‹å³æ‰§è¡Œçš„æ“ä½œ

### æ­¥éª¤1: é‡å¯ Admin åå°

åœ¨è¿è¡Œ seo-admin çš„æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
# è¿›å…¥Adminç›®å½•
cd /www/wwwroot/seo-admin

# æ‹‰å–æœ€æ–°é…ç½®ï¼ˆå¦‚æœä½¿ç”¨Gitï¼‰
git pull origin main

# æˆ–è€…æ‰‹åŠ¨æ›´æ–° .env.local æ–‡ä»¶
nano .env.local
# ä¿®æ”¹è¿™ä¸€è¡Œï¼š
# DATABASE_URL="...&connection_limit=5&pool_timeout=20"

# é‡å¯PM2åº”ç”¨
pm2 restart seo-admin

# æŸ¥çœ‹æ—¥å¿—ç¡®è®¤æ˜¯å¦æ­£å¸¸
pm2 logs seo-admin --lines 50
```

### æ­¥éª¤2: éªŒè¯ä¿®å¤

**æ£€æŸ¥é”™è¯¯æ˜¯å¦æ¶ˆå¤±ï¼š**
```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
pm2 logs seo-admin

# åº”è¯¥ä¸å†çœ‹åˆ°ä»¥ä¸‹é”™è¯¯ï¼š
# âŒ P2024: Timed out fetching a new connection
# âŒ P1001: Can't reach database server
```

**æµ‹è¯•APIå“åº”ï¼š**
```bash
# æµ‹è¯•SEOå¥åº·æ£€æŸ¥API
curl https://adminseohub.xyz/api/seo/health

# æµ‹è¯•ç»Ÿè®¡API
curl https://adminseohub.xyz/api/stats

# åº”è¯¥è¿”å›æ­£å¸¸çš„JSONæ•°æ®ï¼Œè€Œä¸æ˜¯500é”™è¯¯
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### ä¿®å¤å‰ï¼ˆé—®é¢˜çŠ¶æ€ï¼‰
```
å¹¶å‘è¯·æ±‚: 5ä¸ªAPIåŒæ—¶è°ƒç”¨
è¿æ¥æ± : 1ä¸ªè¿æ¥
ç»“æœ:
  - ç¬¬1ä¸ªè¯·æ±‚ï¼šæˆåŠŸ (è·å¾—å”¯ä¸€è¿æ¥)
  - ç¬¬2-5ä¸ªè¯·æ±‚ï¼šç­‰å¾…10ç§’ â†’ è¶…æ—¶å¤±è´¥ âŒ
é”™è¯¯ç‡: 80% (4/5 å¤±è´¥)
```

### ä¿®å¤åï¼ˆæ­£å¸¸çŠ¶æ€ï¼‰
```
å¹¶å‘è¯·æ±‚: 5ä¸ªAPIåŒæ—¶è°ƒç”¨
è¿æ¥æ± : 5ä¸ªè¿æ¥ (Admin) / 3ä¸ªè¿æ¥ (èœ˜è››æ± )
ç»“æœ:
  - æ‰€æœ‰è¯·æ±‚ï¼šæˆåŠŸ âœ…
é”™è¯¯ç‡: 0% (å…¨éƒ¨æˆåŠŸ)
```

---

## ğŸ“‹ éƒ¨ç½²èœ˜è››æ± æ—¶çš„æ³¨æ„äº‹é¡¹

å½“ä½ éƒ¨ç½²èœ˜è››æ± ç½‘ç«™åˆ°3å°VPSæ—¶ï¼š

### âœ… ä½¿ç”¨æ­£ç¡®çš„ç¯å¢ƒå˜é‡

**VPS-1:**
```bash
cd /www/wwwroot/spider-site
cp .env.vps1.example .env.local
# è¿™ä¸ªæ–‡ä»¶å·²ç»åŒ…å« connection_limit=3&pool_timeout=20
```

**VPS-2:**
```bash
cd /www/wwwroot/spider-site
cp .env.vps2.example .env.local
```

**VPS-3:**
```bash
cd /www/wwwroot/spider-site
cp .env.vps3.example .env.local
```

### âš ï¸ ä¸è¦ä½¿ç”¨æ—§çš„é…ç½®

å¦‚æœä½ ä¹‹å‰ä¿å­˜äº†æ—§çš„ `.env.local` æ–‡ä»¶ï¼Œ**ä¸è¦ä½¿ç”¨å®ƒ**ï¼
æ—§æ–‡ä»¶åŒ…å« `connection_limit=1`ï¼Œä¼šå¯¼è‡´ç›¸åŒçš„é—®é¢˜ã€‚

---

## ğŸ” ç›‘æ§å’Œè¯Šæ–­

### å¦‚ä½•æ£€æµ‹è¿æ¥æ± é—®é¢˜

**ç—‡çŠ¶ï¼š**
- APIå“åº”ç¼“æ…¢æˆ–è¶…æ—¶
- æ—¥å¿—ä¸­å‡ºç° `P2024` é”™è¯¯
- æ•°æ®åº“æŸ¥è¯¢å¤±è´¥ç‡é«˜

**è¯Šæ–­å‘½ä»¤ï¼š**
```bash
# æŸ¥çœ‹PM2åº”ç”¨çŠ¶æ€
pm2 status

# å®æ—¶ç›‘æ§ï¼ˆçœ‹CPU/å†…å­˜æ˜¯å¦å¼‚å¸¸ï¼‰
pm2 monit

# æŸ¥çœ‹æœ€è¿‘çš„é”™è¯¯æ—¥å¿—
pm2 logs seo-admin --err --lines 100

# æœç´¢ç‰¹å®šé”™è¯¯
pm2 logs seo-admin | grep "P2024"
pm2 logs seo-admin | grep "connection pool"
```

### æ­£å¸¸è¿è¡Œçš„æ ‡å¿—

âœ… æ²¡æœ‰ `P2024` æˆ– `P1001` é”™è¯¯
âœ… APIå“åº”æ—¶é—´ < 1ç§’
âœ… PM2 æ˜¾ç¤ºåº”ç”¨çŠ¶æ€ä¸º "online"
âœ… æ—¥å¿—ä¸­æ²¡æœ‰ Prisma é”™è¯¯

---

## ğŸ“š æŠ€æœ¯è¯´æ˜

### ä¸ºä»€ä¹ˆ connection_limit=1 ä¼šå‡ºé—®é¢˜ï¼Ÿ

**åœºæ™¯ï¼š** Admin Dashboard åŠ è½½

å½“ç”¨æˆ·æ‰“å¼€ Admin Dashboard æ—¶ï¼Œå‰ç«¯ä¼šåŒæ—¶å‘é€å¤šä¸ªAPIè¯·æ±‚ï¼š
```
1. GET /api/stats          (ç»Ÿè®¡æ•°æ®)
2. GET /api/seo/health     (SEOå¥åº·)
3. GET /api/spider-pool/stats (èœ˜è››æ± ç»Ÿè®¡)
4. GET /api/keywords       (å…³é”®è¯åˆ—è¡¨)
5. GET /api/downloads      (ä¸‹è½½é…ç½®)
```

**ä½¿ç”¨ connection_limit=1:**
```
æ—¶é—´è½´ï¼š
0s   - è¯·æ±‚1è·å¾—è¿æ¥ï¼Œå¼€å§‹æŸ¥è¯¢
0.5s - è¯·æ±‚2-5ç­‰å¾…
1s   - è¯·æ±‚1å®Œæˆï¼Œé‡Šæ”¾è¿æ¥
1s   - è¯·æ±‚2è·å¾—è¿æ¥
1.5s - è¯·æ±‚2å®Œæˆ
...
10s  - è¯·æ±‚3-5è¶…æ—¶ âŒ
```

**ä½¿ç”¨ connection_limit=5:**
```
æ—¶é—´è½´ï¼š
0s   - æ‰€æœ‰5ä¸ªè¯·æ±‚åŒæ—¶è·å¾—è¿æ¥
1s   - æ‰€æœ‰5ä¸ªè¯·æ±‚å®Œæˆ âœ…
```

### PgBouncer è¿æ¥æ± 

Supabase ä½¿ç”¨ PgBouncer ä½œä¸ºè¿æ¥æ± ç®¡ç†å™¨ï¼š
- **Transaction mode:** æ¯ä¸ªäº‹åŠ¡ä½¿ç”¨ä¸€ä¸ªè¿æ¥
- **æ¨èè®¾ç½®ï¼š**
  - Small apps: 2-3 connections
  - Medium apps: 5-10 connections
  - Large apps: 10-20 connections

æˆ‘ä»¬çš„é…ç½®ï¼š
- **Admin (5):** ä¸­å‹åº”ç”¨ï¼Œå¤šä¸ªä»ªè¡¨ç›˜åŒæ—¶åŠ è½½
- **Spider sites (3):** å°å‹åº”ç”¨ï¼Œæ¯ä¸ªVPSç‹¬ç«‹è¿è¡Œ

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] æ›´æ–°äº† seo-admin çš„ `.env.local`
- [ ] é‡å¯äº† seo-admin PM2 åº”ç”¨
- [ ] éªŒè¯æ—¥å¿—ä¸­æ²¡æœ‰ P2024/P1001 é”™è¯¯
- [ ] æµ‹è¯• Admin Dashboard åŠ è½½æ­£å¸¸
- [ ] API å“åº”é€Ÿåº¦æ­£å¸¸ï¼ˆ< 1ç§’ï¼‰
- [ ] å‡†å¤‡å¥½æ­£ç¡®çš„èœ˜è››æ±  VPS ç¯å¢ƒå˜é‡æ–‡ä»¶

---

## ğŸ†˜ å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

1. **æ£€æŸ¥ Supabase æ•°æ®åº“çŠ¶æ€**
   - ç™»å½• Supabase Dashboard
   - æŸ¥çœ‹æ•°æ®åº“æ˜¯å¦åœ¨çº¿
   - æ£€æŸ¥æ˜¯å¦æœ‰é™æµæˆ–é…é¢é™åˆ¶

2. **æ£€æŸ¥æœåŠ¡å™¨èµ„æº**
   ```bash
   # æ£€æŸ¥å†…å­˜
   free -h

   # æ£€æŸ¥CPU
   top

   # æ£€æŸ¥ç£ç›˜
   df -h
   ```

3. **å¢åŠ è¿æ¥æ•°ï¼ˆå¦‚æœéœ€è¦ï¼‰**
   å¦‚æœé”™è¯¯ç»§ç»­å‡ºç°ï¼Œå¯ä»¥å°è¯•å¢åŠ ï¼š
   ```env
   # Admin: 5 â†’ 10
   DATABASE_URL="...&connection_limit=10&pool_timeout=30"
   ```

4. **è”ç³» Supabase æ”¯æŒ**
   å¦‚æœæ˜¯æ•°æ®åº“ç«¯çš„é—®é¢˜ï¼Œå¯èƒ½éœ€è¦å‡çº§ Supabase è®¡åˆ’

---

**ä¿®å¤å®Œæˆåï¼Œä½ çš„åº”ç”¨åº”è¯¥ç¨³å®šè¿è¡Œï¼Œä¸å†å‡ºç°è¿æ¥è¶…æ—¶é”™è¯¯ï¼** ğŸ‰
